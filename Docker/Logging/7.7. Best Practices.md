# 7.7. Best Practices.md


#### 1. Thiết kế log ngay từ ứng dụng

* **Sinh structured log** (JSON, logfmt…) thay vì plain text.
* Luôn bao gồm các trường:

  * `timestamp`
  * `level` (`info`, `warn`, `error`, …)
  * `message`
  * `service` / `component`
  * `request_id` hoặc `trace_id` (để trace request xuyên suốt microservices)
* Không log **thông tin nhạy cảm**: mật khẩu, token, số thẻ tín dụng.

#### 2. Chọn logging driver phù hợp

| Driver        | Khi nào dùng                                           | Nhược điểm          |
| ------------- | ------------------------------------------------------ | ------------------- |
| **json-file** | Dev/test, hoặc cần log local và đọc bằng `docker logs` | Dễ đầy ổ đĩa        |
| **local**     | Sản xuất, hiệu quả hơn `json-file`                     | Không hỗ trợ remote |
| **fluentd**   | Dùng stack ELK / EFK, gửi log structured               | Cần Fluentd agent   |
| **gelf**      | Gửi tới Graylog                                        | Cần Graylog setup   |
| **awslogs**   | AWS CloudWatch                                         | AWS only            |
| **splunk**    | Tích hợp Splunk                                        | Cần license Splunk  |

#### 3. Tối ưu dung lượng log

* Bật **log rotation** cho driver `json-file` hoặc `local`:

```jsonc
// /etc/docker/daemon.json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

→ Giới hạn 3 file log, mỗi file 10MB.

* Forward log ra ngoài ngay lập tức thay vì giữ lâu trên host.
#### 4. Dùng stdout/stderr thay vì ghi file trong container

* Container nên gửi log ra **stdout** / **stderr**.
* Để Docker hoặc logging driver xử lý log.
* Tránh ghi trực tiếp file log bên trong container → khó quản lý, không có rotation.
#### 5. Giữ format log đồng nhất trên toàn hệ thống

* Quy định trước **schema log** (naming, field bắt buộc).
* Tất cả service dùng chung logging library hoặc middleware.
* Ví dụ với microservices → tất cả service log:

```json
{
  "ts": "2025-08-13T16:00:00Z",
  "level": "info",
  "service": "payment",
  "msg": "Payment successful",
  "user_id": 123
}
```
#### 6. Giám sát & cảnh báo từ log

* Tích hợp với **Prometheus + Loki**, **ELK**, hoặc **Splunk** để:

  * Tìm kiếm log theo query.
  * Gửi cảnh báo khi số lượng log lỗi vượt ngưỡng.
* Ví dụ Prometheus alert rule (qua Loki):

```yaml
expr: rate({level="error"}[5m]) > 5
for: 1m
labels:
  severity: critical
annotations:
  description: "Error logs rate too high"
```
#### 7. Bảo mật log

* Mã hóa log khi gửi qua mạng (TLS).
* Ẩn/mask thông tin nhạy cảm trước khi ghi log.
* Giới hạn quyền truy cập hệ thống lưu trữ log.
#### 8. Kiểm thử chiến lược logging

* Test log khối lượng lớn để xem hiệu năng.
* Mô phỏng sự cố (mạng chậm, log server down) → đảm bảo không mất log.
* Đảm bảo log parse được với công cụ phân tích.
