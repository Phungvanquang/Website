# 7.8. Logging Troubleshooting

## 1. Kiểm tra driver hiện tại

Xem logging driver mà container đang dùng:

```bash
docker inspect <container_id> --format '{{.HostConfig.LogConfig.Type}}'
```

→ Đảm bảo driver khớp với cấu hình mong muốn (vd: `json-file`, `local`, `fluentd`).

Nếu không đúng, cần recreate container với driver phù hợp.
## 2. Xem log bằng CLI

* **docker logs**:

```bash
docker logs <container_id>
docker logs --tail 100 -f <container_id>  # stream log
```

* Nếu báo lỗi:

  * `Error response from daemon: configured logging driver does not support reading`
    → Driver hiện tại không hỗ trợ `docker logs` (vd: `fluentd`, `gelf`).
## 3. Kiểm tra dung lượng & rotation

* **Kiểm tra file log trực tiếp** (khi dùng `json-file` hoặc `local`):

```bash
ls -lh /var/lib/docker/containers/<container_id>/*-json.log
```

* Nếu file quá lớn → rotation chưa cấu hình hoặc không hoạt động.
* Kích hoạt rotation trong `/etc/docker/daemon.json`:

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

→ Restart Docker daemon sau khi chỉnh.
## 4. Debug logging driver

* Với **Fluentd**:

  * Kiểm tra container fluentd agent có chạy và nhận log không.
  * Xem lỗi network (`docker network inspect`).
  * Kiểm tra port TCP/UDP mở đúng.

* Với **Syslog**:

  * Kiểm tra syslog server logs.
  * Dùng `nc -u` hoặc `nc -v` để test kết nối.
## 5. Phân tích log của Docker daemon

* Docker daemon log lưu tại:

  * **systemd-based**:

    ```bash
    journalctl -u docker.service
    ```
  * **sysvinit**:

    ```bash
    cat /var/log/docker.log
    ```

* Tìm lỗi liên quan tới logging:

```bash
journalctl -u docker.service | grep log
```
## 6. Xử lý container không log ra stdout/stderr

* Một số ứng dụng log vào file nội bộ thay vì stdout/stderr.
* Cách xử lý:

  1. Sửa cấu hình app để log ra stdout/stderr.
  2. Hoặc mount file log và tail:

     ```bash
     docker exec -it <container_id> tail -f /path/to/logfile.log
     ```
## 7. Kiểm tra performance của logging

* Log quá nhiều có thể gây:

  * Tăng CPU sử dụng.
  * Gây I/O bottleneck.
* Giải pháp:

  * Giảm verbosity level (`info` → `warn`/`error`).
  * Dùng driver tối ưu (`local` thay vì `json-file` nếu không cần structured log local).
  * Forward log trực tiếp ra log collector thay vì lưu local lâu.
## 8. Checklist xử lý sự cố

- Driver đúng loại?
- Log rotation hoạt động?
- App log ra stdout/stderr?
- Log collector nhận dữ liệu?
- Không có bottleneck I/O hoặc network?
- Không mất log khi container restart?



