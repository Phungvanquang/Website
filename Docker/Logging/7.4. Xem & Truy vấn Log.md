# 7.4. Xem & Truy vấn Log

## **1. Mục tiêu**

* Gửi log container từ host Docker đến hệ thống logging tập trung (centralized logging).
* Hỗ trợ truy vết sự cố, phân tích bảo mật, audit log.
* Giảm tải lưu trữ log trên host.
## **2. Nguyên tắc**

* **Docker không tự lưu trữ log tập trung** — bạn phải cấu hình **logging driver** hoặc dùng **sidecar container**.
* Một container chỉ có thể dùng **một logging driver** tại một thời điểm.
* Một số logging driver hỗ trợ gửi log trực tiếp (Fluentd, Syslog, gelf, splunk…).
## **3. Các logging driver phổ biến cho remote logging**

| Driver      | Hệ thống nhận log                  | Ưu điểm                               | Nhược điểm                                       |
| ----------- | ---------------------------------- | ------------------------------------- | ------------------------------------------------ |
| **fluentd** | Fluentd / Fluent Bit               | Nhiều plugin, mạnh về parse & forward | Cần cài đặt fluentd trên host hoặc trong network |
| **syslog**  | Syslog server (rsyslog, syslog-ng) | Chuẩn truyền thống, dễ tích hợp SIEM  | Không tối ưu khi log nhiều                       |
| **gelf**    | Graylog, Logstash GELF input       | Có cấu trúc JSON, tốt cho phân tích   | Cần setup Graylog/Logstash                       |
| **awslogs** | AWS CloudWatch Logs                | Quản lý tập trung trên AWS            | Khóa vào AWS ecosystem                           |
| **splunk**  | Splunk Enterprise/Cloud            | Tích hợp mạnh mẽ, real-time search    | Chi phí cao                                      |
| **gcplogs** | Google Cloud Logging               | Native GCP                            | Khóa vào GCP ecosystem                           |
## **4. Ví dụ triển khai thực tế**
### **4.1. Gửi log tới Fluentd**

```bash
docker run -d \
  --log-driver=fluentd \
  --log-opt fluentd-address=192.168.1.10:24224 \
  --log-opt tag="docker.{{.Name}}" \
  --log-opt fluentd-async-connect=true \
  my_app
```

**Trong Fluentd config:**

```conf
<source>
  @type forward
  port 24224
</source>

<match docker.*>
  @type file
  path /var/log/docker/container.log
  append true
</match>
```
### **4.2. Gửi log tới Syslog server**

```bash
docker run -d \
  --log-driver=syslog \
  --log-opt syslog-address=udp://192.168.1.20:514 \
  --log-opt tag="{{.Name}}" \
  nginx
```

> `udp://` nhanh nhưng không đảm bảo truyền đủ log, `tcp://` an toàn hơn.
### **4.3. Gửi log tới Graylog (GELF driver)**

```bash
docker run -d \
  --log-driver=gelf \
  --log-opt gelf-address=udp://192.168.1.30:12201 \
  --log-opt tag="my_service" \
  my_app
```

Graylog Input:

* Type: **GELF UDP**
* Port: **12201**
### **4.4. Gửi log tới AWS CloudWatch**
```bash
docker run -d \
  --log-driver=awslogs \
  --log-opt awslogs-group=my-docker-logs \
  --log-opt awslogs-region=ap-southeast-1 \
  --log-opt awslogs-stream={{.Name}} \
  my_app
```

> Cần cấu hình AWS CLI và quyền `logs:PutLogEvents`.
### **4.5. Gửi log tới Splunk**

```bash
docker run -d \
  --log-driver=splunk \
  --log-opt splunk-token=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \
  --log-opt splunk-url=https://splunk.example.com:8088 \
  --log-opt splunk-verify-ssl=false \
  my_app
```
## **5. Kịch bản triển khai thực tế**

* **Production microservices** → dùng **Fluent Bit** trên mỗi node → forward log về **Elasticsearch / Loki**.
* **Legacy app** → dùng **syslog** driver gửi log đến SIEM.
* **Kubernetes** → không dùng Docker logging driver mà mount stdout/stderr → log collector như Fluent Bit.
* **Hybrid cloud** → AWS/EKS + Fluent Bit → CloudWatch & S3.
## **6. Best Practices**
- Luôn **tag log** theo `{env}.{service}.{container}` để dễ lọc.
- Dùng **async connect** để tránh container fail nếu log server tạm ngưng.
- Tối ưu **buffer** ở driver hoặc log forwarder để giảm load network.
- Chia **log pipeline**: raw logs → parse → enrich → store.
- Dùng **TLS** khi gửi log qua internet để bảo mật.
## **7. Kiểm tra log đã gửi thành công**

* Fluentd:

```bash
fluent-cat docker.test '{"msg":"hello"}'
```

* Syslog:

```bash
logger -n 192.168.1.20 -P 514 "Test log from Docker"
```

* Graylog:
  Xem **Search** trong giao diện Graylog.

