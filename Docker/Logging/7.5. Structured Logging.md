# 7.5. Structured Logging.md

#### 1. Lợi ích của Structured Logging

* **Dễ parse**: Công cụ như `jq`, Elasticsearch, Splunk, Loki… có thể đọc log nhanh hơn.
* **Dễ tìm kiếm**: Truy vấn theo field (ví dụ: `level=ERROR`, `service=payment`).
* **Tự động hóa**: Hệ thống cảnh báo có thể trigger dựa vào giá trị trong log.
* **Chuẩn hóa**: Giữ format thống nhất giữa các service.
#### 2. Các định dạng phổ biến

| Định dạng     | Mô tả                                                       | Ví dụ                                               |
| ------------- | ----------------------------------------------------------- | --------------------------------------------------- |
| **JSON**      | Phổ biến nhất, dễ tích hợp.                                 | `{"level":"info","msg":"user login","user_id":123}` |
| **Key-Value** | Dùng dấu `=` phân tách, dễ đọc với mắt thường.              | `level=info msg="user login" user_id=123`           |
| **Logfmt**    | Giống key-value nhưng chuẩn hóa hơn, dùng trong Prometheus. | `ts=2025-08-13T15:30:00Z level=error err="timeout"` |

---

#### 3. Structured Logging trong Docker
##### a) Docker mặc định

* Driver `json-file` ghi log dạng JSON **nhưng** log message là plain text bên trong field `"log"`.
* Ví dụ:

```json
{"log":"User login success\n","stream":"stdout","time":"2025-08-13T15:00:00.123456789Z"}
```

→ Bạn cần ứng dụng sinh log **structured** ngay từ code.
##### b) Ghi structured log từ ứng dụng

Ví dụ Node.js:

```javascript
console.log(JSON.stringify({
  ts: new Date().toISOString(),
  level: "info",
  msg: "User login",
  user_id: 123
}));
```

Ví dụ Go (logrus):

```go
log.WithFields(log.Fields{
    "user_id": 123,
    "action": "login",
}).Info("User login")
```
##### c) Kết hợp với logging driver

* **fluentd**: Tự động gửi structured log đến Fluentd → Elasticsearch.
* **gelf**: Gửi log dạng structured tới Graylog.
* **awslogs**: Gửi structured log lên CloudWatch.
* **json-file**: Lưu local, phân tích bằng jq.

#### 4. Truy vấn Structured Log

Ví dụ dùng `jq` để lọc:

```bash
docker logs myapp | jq 'select(.level=="error") | {ts, msg, user_id}'
```

Tìm tất cả log từ `service=payment` trong 10 phút gần đây:

```bash
docker logs --since 10m myapp | jq 'select(.service=="payment")'
```
#### 5. Best Practices

* Luôn thêm **timestamp**, **level**, **message**.
* Dùng key tên ngắn gọn, snake\_case hoặc camelCase thống nhất.
* Tránh log quá nhiều thông tin nhạy cảm (mật khẩu, token).
* Với microservices → giữ **schema log** đồng nhất để dễ parse.
#### 6. Mô hình tích hợp

1. **Ứng dụng** sinh structured log (JSON).
2. **Docker logging driver** forward log → Fluentd / Logstash.
3. **Hệ thống lưu trữ & tìm kiếm** (Elasticsearch, Loki, Splunk).
4. **Dashboard & Alert** (Kibana, Grafana).


