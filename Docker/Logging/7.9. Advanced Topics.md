# 7.9. Advanced Topics.md


#### 1. Sidecar Logging Pattern

* **Mục tiêu:** Tách logging ra khỏi ứng dụng chính để dễ quản lý và mở rộng.
* **Cách làm:**

  * Container chính ghi log ra **stdout/stderr** hoặc file.
  * Container sidecar (vd: Fluent Bit, Logstash) đọc log từ volume shared và gửi đi.
* **Ưu điểm:**

  * Không phụ thuộc driver Docker.
  * Hỗ trợ filter, transform, enrich log trước khi gửi.
* **Ví dụ:**

```yaml
version: "3.9"
services:
  app:
    image: my-app
    volumes:
      - logs:/var/log/app
  log-collector:
    image: fluent/fluent-bit
    volumes:
      - logs:/var/log/app
volumes:
  logs:
```
#### 2. Multi-line Log Handling

* Một số log (như stack trace) trải dài nhiều dòng → gây khó cho hệ thống log aggregator.
* **Giải pháp:**

  * Dùng logging driver hoặc collector hỗ trợ multi-line parsing (Fluent Bit, Fluentd, Filebeat).
  * Cấu hình regex match cho log pattern:

```conf
[MULTILINE_PARSER]
    Name          java
    Type          regex
    Flush_Timeout 1000
    Rule          "start_state"   "^\d{4}-\d{2}-\d{2}"  "cont"
    Rule          "cont"          "^\s+"                "cont"
```
#### 3. Structured Logging

* Thay vì plain text, xuất log ở định dạng JSON hoặc protobuf.
* **Lợi ích:**

  * Dễ parse, query, filter trên Elasticsearch, Loki, Splunk.
* **Cách làm:**

  * App log ra JSON.
  * Docker logging driver `json-file` giữ nguyên format.
* **Ví dụ log JSON:**

```json
{"level":"error","ts":"2025-08-13T12:34:56Z","msg":"database connection failed","error":"timeout"}
```
#### 4. Enriching Logs with Metadata

* **Gắn thêm label, env info, container ID** vào log.
* **Dùng label trong Docker:**

```bash
docker run --label service=payments --label env=prod my-app
```

* Trong Fluentd / Fluent Bit, lấy metadata từ Docker API (`docker.sock`) để append vào log.
#### 5. Remote Log Buffering & Reliability

* Khi log collector remote bị down → tránh mất log.
* **Giải pháp:**

  * Dùng driver hỗ trợ buffering (`fluentd`, `awslogs`).
  * Cấu hình `fluentd-buffer-limit` hoặc `max-buffer-size`.
* **Ví dụ:**

```bash
docker run \
  --log-driver=fluentd \
  --log-opt fluentd-buffer-limit=10m \
  my-app
```
#### 6. Secure Logging

* Tránh lộ thông tin nhạy cảm:

  * Dùng log scrubber (Fluent Bit filter, Logstash mutate).
  * Encrypt log khi gửi qua network (TLS).
* Ví dụ với Fluent Bit TLS:

```conf
[OUTPUT]
    Name  forward
    Host  logs.mycompany.com
    Port  24284
    TLS   On
```
#### 7. Performance Optimization

* **Vấn đề:** Logging sync quá mức → chậm app.
* **Giải pháp:**

  * Dùng driver `local` để giảm I/O.
  * Batch log trước khi gửi.
  * Giảm log level khi không debug.
#### 8. Observability Integration

* Tích hợp log + metrics + traces:

  * Dùng **OpenTelemetry** để export cả log + span.
  * Đồng bộ log timestamp với metrics (Prometheus) để correlate sự kiện.
#### 9. Rotating & Archiving Centralized Logs

* Lưu log lâu dài mà không làm đầy storage.
* Sử dụng:

  * **S3 / GCS** cho archive.
  * **Logstash + Elasticsearch** cho search.
  * Lifecycle rules để xóa log cũ sau X ngày.
