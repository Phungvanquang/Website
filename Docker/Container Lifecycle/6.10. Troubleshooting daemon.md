# 6.10. Troubleshooting daemon.md

#### **1. Mục tiêu**

* Xác định và khắc phục sự cố với **Docker daemon** (`dockerd`) khi daemon bị crash, không start, hoạt động chậm hoặc lỗi mạng.
* Cung cấp checklist điều tra cho môi trường **production**.
#### **2. Kiến thức nền**

* **Docker daemon** (`dockerd`) là tiến trình chính quản lý containers, images, networks, volumes.
* Nếu daemon gặp sự cố → toàn bộ containers bị ảnh hưởng.
* Lỗi có thể đến từ:

  * Config sai (`daemon.json`)
  * Storage backend hỏng
  * Xung đột network / firewall
  * Quá tải CPU, RAM, I/O
  * Lỗi plugin hoặc runtime
#### **3. Các bước xử lý**
##### **3.1. Kiểm tra trạng thái daemon**

```bash
sudo systemctl status docker
sudo systemctl is-active docker
sudo systemctl is-enabled docker
```

* Nếu inactive → daemon chưa start hoặc crash.
##### **3.2. Xem logs**

```bash
# Xem log mặc định (journald)
journalctl -u docker.service --no-pager -n 50

# Xem log full
journalctl -fu docker.service
```

* Tìm các từ khóa: `error`, `failed`, `fatal`, `panic`.
##### **3.3. Bật debug mode**

Tạm thời:

```bash
sudo dockerd --debug
```

Hoặc bật vĩnh viễn trong `/etc/docker/daemon.json`:

```json
{
  "debug": true
}
```

→ Restart Docker:

```bash
sudo systemctl restart docker
```
### **3.4. Kiểm tra cấu hình**

```bash
docker info
docker system info
```

* Xem thông tin storage driver, runtime, network.
* Lỗi `"ERROR: failed to start daemon: ..."` thường liên quan tới:

  * Sai `hosts` trong cấu hình
  * TLS cert hết hạn
  * Storage backend hỏng
##### **3.5. Kiểm tra dung lượng**

```bash
docker system df
df -h
```

* Storage full → daemon có thể không tạo container mới.
* Xóa tài nguyên không dùng:

```bash
docker system prune -a --volumes
```
##### **3.6. Kiểm tra network daemon**

```bash
docker network ls
docker network inspect <network>
```

* Nếu overlay network bị lỗi trong Swarm → cần reset hoặc recreate.
##### **3.7. Kiểm tra runtime**

```bash
docker info | grep Runtime
```

* Nếu dùng **gVisor/Kata** và gặp crash → test lại bằng `runc`.
##### **3.8. Kiểm tra plugin**

```bash
docker plugin ls
docker plugin disable <plugin>
```

* Plugin lỗi có thể ngăn daemon start.
##### **3.9. Test API daemon**

```bash
curl --unix-socket /var/run/docker.sock http://localhost/_ping
```

* Trả về `"OK"` → daemon hoạt động.
#### **4. Khắc phục sự cố thường gặp**

| Triệu chứng           | Nguyên nhân                           | Giải pháp                                              |
| --------------------- | ------------------------------------- | ------------------------------------------------------ |
| Docker không start    | Lỗi config `daemon.json`              | Xóa hoặc sửa config, restart daemon                    |
| Container không start | Storage full                          | Xóa unused images, volumes                             |
| Mất kết nối network   | iptables rule xung đột                | Reset iptables hoặc restart daemon                     |
| TLS error             | Chứng chỉ hết hạn hoặc sai CA         | Cấp mới cert                                           |
| Daemon CPU 100%       | Container log quá lớn hoặc event loop | Xoá log file `/var/lib/docker/containers/*/*-json.log` |
#### **5. Công cụ hỗ trợ**

* **`dockerd --debug`** – Chạy daemon ở chế độ debug.
* **`docker system events`** – Theo dõi event real-time.
* **`strace -p $(pidof dockerd)`** – Theo dõi syscalls.
* **cAdvisor / Prometheus** – Giám sát resource usage.
#### **6. Best Practices**

* Giữ `daemon.json` gọn, backup trước khi thay đổi.
* Giới hạn log size container (`max-size`, `max-file`).
* Không cài plugin không cần thiết.
* Giám sát disk & inode thường xuyên.
* Dùng **systemd watchdog** để tự restart daemon khi crash.

