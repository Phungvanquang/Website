# 6.9. Remote daemon access.md

#### **1. Khái niệm**

* Mặc định Docker CLI kết nối tới daemon qua **Unix socket** (`/var/run/docker.sock`), chỉ dùng được trên local host.
* **Remote daemon access** cho phép kết nối tới Docker daemon **qua TCP**, thường dùng khi:

  * Quản lý Docker trên nhiều máy từ một client.
  * Tích hợp CI/CD (Jenkins, GitLab Runner, Drone CI...).
  * Tự động deploy từ máy dev sang server.
* **⚠️ Cảnh báo bảo mật**: Mở TCP mà không có TLS = trao quyền root cho bất kỳ ai kết nối được.
#### **2. Bật TCP socket cho Docker daemon**

##### **2.1. Sửa `daemon.json`**

File: `/etc/docker/daemon.json`

```json
{
  "hosts": [
    "unix:///var/run/docker.sock",
    "tcp://0.0.0.0:2375"
  ]
}
```

* `2375` = TCP không mã hóa (chỉ dùng cho mạng nội bộ hoặc lab).
* Không khuyến nghị trong môi trường production.
##### **2.2. Restart Docker**

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```
#### **3. Kết nối từ máy remote**

```bash
docker -H tcp://server-ip:2375 ps
```

* `-H` hoặc `DOCKER_HOST` env để chỉ định daemon.
#### **4. Bảo mật với TLS**

##### **4.1. Tạo chứng chỉ TLS**

```bash
# Tạo CA
openssl genrsa -aes256 -out ca-key.pem 4096
openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem

# Tạo server cert
openssl genrsa -out server-key.pem 4096
openssl req -subj "/CN=server" -new -key server-key.pem -out server.csr
openssl x509 -req -days 365 -in server.csr -CA ca.pem -CAkey ca-key.pem \
  -CAcreateserial -out server-cert.pem -extfile <(echo subjectAltName = IP:SERVER_IP)

# Tạo client cert
openssl genrsa -out key.pem 4096
openssl req -subj "/CN=client" -new -key key.pem -out client.csr
openssl x509 -req -days 365 -in client.csr -CA ca.pem -CAkey ca-key.pem \
  -CAcreateserial -out cert.pem -extfile <(echo extendedKeyUsage = clientAuth)
```
##### **4.2. Cấu hình daemon để dùng TLS**

File: `/etc/docker/daemon.json`

```json
{
  "hosts": ["tcp://0.0.0.0:2376", "unix:///var/run/docker.sock"],
  "tlsverify": true,
  "tlscacert": "/etc/docker/ca.pem",
  "tlscert": "/etc/docker/server-cert.pem",
  "tlskey": "/etc/docker/server-key.pem"
}
```

* Port 2376 là chuẩn cho TLS.
##### **4.3. Restart Docker**

```bash
sudo systemctl restart docker
```
#### **5. Kết nối từ client qua TLS**

```bash
docker --tlsverify \
  --tlscacert=ca.pem \
  --tlscert=cert.pem \
  --tlskey=key.pem \
  -H tcp://SERVER_IP:2376 ps
```

Hoặc set biến môi trường:

```bash
export DOCKER_TLS_VERIFY=1
export DOCKER_CERT_PATH=~/.docker
export DOCKER_HOST=tcp://SERVER_IP:2376
docker ps
```
#### **6. Best Practices**

* **Chỉ mở TCP qua TLS** – không dùng 2375 trong môi trường production.
* **Hạn chế IP truy cập** bằng firewall (`iptables`, `ufw`, security group).
* **Không cấp client cert cho người không cần** → họ sẽ có quyền root trên daemon.
* Nếu chỉ dùng trong LAN → xem xét thay bằng **SSH tunneling**:

```bash
docker -H ssh://user@server ps
```
#### **7. Troubleshooting**

| Lỗi                                                | Nguyên nhân                              | Cách xử lý                           |
| -------------------------------------------------- | ---------------------------------------- | ------------------------------------ |
| `error during connect: Get ... connection refused` | Port chưa mở hoặc daemon chưa listen TCP | Kiểm tra `hosts` trong `daemon.json` |
| `x509: certificate signed by unknown authority`    | CA chưa được tin cậy                     | Đảm bảo `--tlscacert` đúng           |
| Rất chậm khi connect                               | TLS handshake hoặc mạng chậm             | Kiểm tra MTU, ping                   |
