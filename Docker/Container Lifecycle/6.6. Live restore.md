# 6.6. Live restore.md

#### **1. Khái niệm**

* **Live Restore** cho phép container **tiếp tục chạy** ngay cả khi Docker daemon **bị restart hoặc stop**.
* Giúp giảm downtime khi:

  * Nâng cấp Docker daemon.
  * Restart host daemon để cấu hình lại.
  * Khởi động lại máy chủ nhanh chóng mà không kill container.
* Mặc định **tắt** vì tính năng này cần bật cấu hình trước.
#### **2. Cách hoạt động**

* Khi Live Restore bật:

  * Container processes chạy trực tiếp dưới Linux namespaces & cgroups, không phụ thuộc vào daemon process để duy trì.
  * Docker daemon lưu state metadata định kỳ → khi daemon restart, nó attach lại các container đang chạy.
* Giới hạn:

  * Không thể **create container mới** khi daemon tắt.
  * Một số tính năng cần daemon (log streaming, exec) sẽ không hoạt động khi daemon offline.
  * Chỉ hỗ trợ Linux.
#### **3. Bật Live Restore**

##### **3.1. Sửa cấu hình daemon.json**

File: `/etc/docker/daemon.json`

```json
{
  "live-restore": true
}
```
##### **3.2. Khởi động lại Docker daemon**

```bash
sudo systemctl restart docker
```

> Container hiện tại sẽ không bị dừng khi daemon restart nếu Live Restore bật.
#### **4. Kiểm tra trạng thái**

```bash
docker info | grep "Live Restore"
# Expected output:
# Live Restore Enabled: true
```
#### **5. Demo thực tế**

##### **5.1. Chạy container lâu dài**

```bash
docker run -d --name test-live nginx
```

##### **5.2. Restart Docker daemon**

```bash
sudo systemctl restart docker
```

##### **5.3. Kiểm tra container**

```bash
docker ps
# Container vẫn chạy, không bị restart.
```
#### **6. Khi nào nên dùng**

* **Production**:

  * Khi downtime 0s là yêu cầu bắt buộc (e.g., web service, database replication node).
  * Khi muốn update cấu hình Docker daemon nhanh.
* **Dev/Test**:

  * Khi test resilience của ứng dụng khi daemon bị crash.
#### **7. Best Practices**

1. **Kết hợp với Restart Policies** → đảm bảo container tự khởi động nếu host reboot.
2. Theo dõi container bằng healthcheck → để biết container còn hoạt động sau khi daemon attach lại.
3. Cẩn trọng với container chạy multi-process → vì daemon không thể quản lý process bị crash khi nó offline.
4. Nếu cần thao tác quản trị (docker exec, logs) → phải bật lại daemon.
#### **8. Troubleshooting**

* **Container biến mất sau daemon restart**:

  * Kiểm tra `daemon.json` có `"live-restore": true`.
  * Đảm bảo restart bằng `systemctl restart docker` thay vì reboot host.
* **Không attach được logs khi daemon offline**:

  * Đây là giới hạn của Live Restore → log streaming yêu cầu daemon.
#### **9. So sánh với Restart Policy**

| Feature               | Live Restore            | Restart Policy                |
| --------------------- | ----------------------- | ----------------------------- |
| Khi daemon restart    | Container vẫn chạy      | Container bị restart          |
| Khi host reboot       | Không restart container | Container restart theo policy |
| Yêu cầu config trước  | Có                      | Có                            |
| Tương thích với Swarm | Có                      | Có                            |

#### **10. Case Study Production**

* **Scenario**: Upgrade Docker daemon từ 20.10.14 → 20.10.24.
* **Steps**:

  1. Bật `"live-restore": true` trong `daemon.json`.
  2. Chạy các service quan trọng: Nginx reverse proxy, Redis cache.
  3. Restart Docker daemon để áp dụng bản vá bảo mật.
  4. Kiểm tra uptime → tất cả service không gián đoạn.


