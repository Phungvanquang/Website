# 6.12. Container Lifecycle Hooks

## **1. Khái niệm**

**Container Lifecycle Hooks** là các hành động (scripts, lệnh) được thực thi **tại các điểm cụ thể** trong vòng đời container:

* **Before start** (trước khi app chính chạy)
* **After start** (ngay sau khi container khởi động)
* **Before stop** (trước khi container dừng)
* **After stop** (sau khi container dừng)
* **On restart** (sau khi restart)

Mục tiêu:

* Tự động **khởi tạo dữ liệu** hoặc chuẩn bị môi trường.
* **Cleanup** khi container dừng.
* Gửi **alert** khi app restart hoặc gặp lỗi.

## **2. Docker & Hooks – Các giới hạn**

* Docker CLI **không** có API hooks native.
* Hooks được triển khai qua:

  * **ENTRYPOINT / CMD** trong Dockerfile.
  * **Signal trapping** trong process chính (`trap` trong bash, signal handler trong Go/Python).
  * **Init scripts** hoặc process manager (supervisord, s6, tini).
  * **Orchestrator hooks** (Docker Compose `depends_on` + `healthcheck`, Swarm configs, Kubernetes lifecycle hooks).

## **3. Cài đặt Hooks trong Docker**

### **3.1. Hook Before Start**

Thực hiện lệnh **trước khi app chính chạy** bằng cách dùng entrypoint script:

```dockerfile
COPY docker-entrypoint.sh /usr/local/bin/
ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]
```

`docker-entrypoint.sh`:

```bash
#!/bin/sh
set -e
echo "[HOOK] Preparing environment..."
chown -R www-data:www-data /var/www/html
exec "$@"
```

* Ưu điểm: chạy mỗi lần container start.
* Ứng dụng: seed database, migrate schema, preload cache.

### **3.2. Hook After Start**

* Docker **không có** after-start hook trực tiếp, nhưng có thể mô phỏng bằng **background job**:

```bash
#!/bin/sh
# docker-entrypoint.sh
"$@" &
APP_PID=$!
echo "[HOOK] App started, running post-start tasks..."
sleep 5
curl -X POST http://monitoring-service:9000/register
wait $APP_PID
```
### **3.3. Hook Before Stop**

* Container nhận **SIGTERM** khi stop.
* Ta bắt tín hiệu này để cleanup:

```bash
#!/bin/bash
trap 'echo "[HOOK] Cleanup before stop..."; rm -rf /tmp/app-cache; exit 0' SIGTERM SIGINT
echo "[APP] Running..."
while true; do sleep 1; done
```

* Ứng dụng: gửi alert, flush logs, save state.
### **3.4. Hook After Stop**

* Docker không có native hook **sau khi container đã stop**.
* Có thể xử lý ở **host level** qua script monitor:

```bash
docker wait <container_id> && ./after_stop.sh
```

Hoặc orchestration (K8s `postStop` hook).
### **3.5. Hook On Restart**

* Dùng entrypoint hoặc process manager để phát hiện restart.
* Ví dụ với file marker:

```bash
if [ -f /tmp/restart.flag ]; then
    echo "[HOOK] Restart detected"
else
    echo "[HOOK] First start"
    touch /tmp/restart.flag
fi
```
## **4. Triển khai Hooks với Orchestrator**

### **4.1. Docker Compose**

* Không có lifecycle hooks native.
* Có thể mô phỏng qua:

  * `command` script + wait-for-it.
  * `depends_on` + `condition: service_healthy`.

### **4.2. Kubernetes**

* Có lifecycle hooks native:

```yaml
lifecycle:
  postStart:
    exec:
      command: ["sh", "-c", "echo PostStart Hook"]
  preStop:
    exec:
      command: ["sh", "-c", "echo PreStop Hook"]
```
## **5. Best Practices**

* Luôn **log rõ ràng** khi hook chạy.
* Giữ hook **ngắn gọn** để tránh delay start/stop quá lâu.
* Bắt và xử lý signal đúng cách (`SIGTERM` cho stop, `SIGHUP` cho reload).
* Tách **logic hook** vào script riêng, không nhúng vào CMD phức tạp.
* Kiểm thử hook trong môi trường staging trước khi áp dụng production.
## **6. Debug Hooks**

* Chạy container ở foreground để quan sát log:

```bash
docker run --rm -it myapp
```

* Xem exit code & logs sau stop:

```bash
docker logs <container_id>
docker inspect <container_id> --format '{{.State.ExitCode}}'
```

**Pro Tip:**
Trong môi trường production với Swarm/Kubernetes, hooks nên:

* Chạy nhanh, không block service quá lâu.
* Có cơ chế retry hoặc timeout.
* Tích hợp với monitoring/alerting (Prometheus Alertmanager, Slack, Email).

