# 6.8. Docker metrics.md

#### **1. Khái niệm**

* Docker daemon có thể xuất **metrics dạng Prometheus** qua HTTP endpoint.
* Dùng để:

  * Giám sát tài nguyên container (CPU, RAM, I/O, network).
  * Theo dõi trạng thái daemon.
  * Tích hợp với **Prometheus + Grafana** để trực quan hóa.
* Metrics này **không bao gồm** log container → chỉ có số liệu runtime.
#### **2. Bật Prometheus metrics cho Docker**

##### **2.1. Sửa `daemon.json`**

File: `/etc/docker/daemon.json`

```json
{
  "metrics-addr": "0.0.0.0:9323",
  "experimental": true
}
```

* `metrics-addr`: Địa chỉ & port export metrics.
* `experimental: true`: Cần bật vì metrics vẫn nằm trong experimental features (Docker 20+ vẫn yêu cầu).
##### **2.2. Restart Docker daemon**

```bash
sudo systemctl restart docker
```
#### **3. Kiểm tra endpoint**

```bash
curl http://localhost:9323/metrics
```

Ví dụ output:

```
# HELP engine_daemon_container_states_containers Number of containers by state
# TYPE engine_daemon_container_states_containers gauge
engine_daemon_container_states_containers{state="running"} 5
engine_daemon_container_states_containers{state="paused"} 0
engine_daemon_container_states_containers{state="stopped"} 2
```
#### **4. Tích hợp Prometheus**

##### **4.1. Cấu hình Prometheus scrape Docker metrics**

File: `prometheus.yml`

```yaml
scrape_configs:
  - job_name: 'docker'
    static_configs:
      - targets: ['docker-host-ip:9323']
```
##### **4.2. Chạy Prometheus và Grafana**

* Prometheus:

```bash
docker run -d --name prometheus \
  -p 9090:9090 \
  -v ./prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus
```

* Grafana:

```bash
docker run -d --name grafana \
  -p 3000:3000 \
  grafana/grafana
```
#### **5. Các metrics quan trọng**

| Metric                                      | Mô tả                                           |
| ------------------------------------------- | ----------------------------------------------- |
| `engine_daemon_container_states_containers` | Số container theo trạng thái (running, stopped) |
| `engine_daemon_engine_cpu_seconds_total`    | Tổng CPU time daemon sử dụng                    |
| `engine_daemon_engine_memory_bytes`         | Memory daemon đang dùng                         |
| `engine_daemon_engine_disk_usage_bytes`     | Dung lượng lưu trữ dùng bởi Docker              |
| `engine_daemon_network_*`                   | Thống kê mạng Docker daemon                     |
#### **6. Bảo mật**

* **Không mở 0.0.0.0 public** trừ khi có firewall hoặc TLS.
* Dùng **Prometheus + Docker daemon trên cùng host** nếu có thể.
* Hoặc bảo vệ bằng reverse proxy + Basic Auth.
#### **7. Best Practices**

1. **Tách Prometheus job** cho Docker daemon và cAdvisor.
2. **Cảnh báo (alerts)**:

   * Container restart rate > X lần/phút.
   * CPU usage > 80% lâu hơn 5 phút.
   * Số container stopped > ngưỡng cho phép.
3. Kết hợp với **Grafana dashboard** template `893` (Docker & system metrics) trên Grafana.com.


