# 6.7. Alternative runtimes.md

## **1. Khái niệm**

* **Container runtime** là lớp thấp nhất chịu trách nhiệm chạy container (thực thi `runc`, quản lý namespaces, cgroups).
* Docker mặc định dùng **`runc`** (OCI-compliant runtime).
* **Alternative runtimes** thay `runc` để:

  * Tăng bảo mật (sandbox).
  * Chạy container như VM nhẹ.
  * Giảm overhead hoặc thêm tính năng đặc thù.
## **2. Các loại alternative runtimes phổ biến**

### **2.1. gVisor**

* **Google phát triển**.
* Sandboxing: container chạy trong user-space kernel giả lập.
* Ưu điểm:

  * Chặn nhiều syscall nguy hiểm.
  * Tốt cho workload multi-tenant.
* Nhược:

  * Giảm hiệu năng (10–20%).
  * Không hỗ trợ full syscall.
* **Cài đặt gVisor**:

```bash
curl -fsSL https://gvisor.dev/install.sh | sh
sudo cp runsc containerd-shim-runsc-v1 /usr/local/bin
```

* **Khai báo trong daemon.json**:

```json
{
  "runtimes": {
    "runsc": {
      "path": "runsc"
    }
  }
}
```

* **Chạy container với gVisor**:

```bash
docker run --rm -it --runtime=runsc alpine sh
```
### **2.2. Kata Containers**

* **VM-based runtime** (dùng QEMU, Firecracker…).
* Container chạy trong **lightweight VM** → isolation mạnh hơn nhiều.
* Ưu điểm:

  * Gần như full isolation như VM.
  * Bảo mật cao cho multi-tenant cloud.
* Nhược:

  * Overhead khởi động cao hơn runc.
* **Cài đặt Kata**:

```bash
sudo apt-get install kata-runtime kata-proxy kata-shim
```

* **daemon.json**:

```json
{
  "runtimes": {
    "kata": {
      "path": "kata-runtime"
    }
  }
}
```

* **Chạy container với Kata**:

```bash
docker run --rm -it --runtime=kata alpine sh
```
### **2.3. crun**

* Runtime viết bằng C (thay vì Go như runc).
* Ưu điểm:

  * Khởi động container nhanh hơn.
  * Dùng ít bộ nhớ hơn.
  * Hỗ trợ cgroups v2 tốt.
* Cài đặt:

```bash
sudo apt install crun
```

* **daemon.json**:

```json
{
  "runtimes": {
    "crun": {
      "path": "crun"
    }
  }
}
```

* Chạy:

```bash
docker run --rm -it --runtime=crun alpine sh
```
## **3. Cấu hình nhiều runtime song song**

`/etc/docker/daemon.json`

```json
{
  "runtimes": {
    "runc": {
      "path": "runc"
    },
    "runsc": {
      "path": "runsc"
    },
    "kata": {
      "path": "kata-runtime"
    },
    "crun": {
      "path": "crun"
    }
  }
}
```
## **4. Khi nào dùng runtime nào?**

| Runtime         | Isolation | Hiệu năng | Dùng cho                                  |
| --------------- | --------- | --------- | ----------------------------------------- |
| runc (default)  | Thấp      | Cao       | Production bình thường, workload tin cậy. |
| gVisor          | Trung     | TB        | Multi-tenant, bảo mật syscall.            |
| Kata Containers | Rất cao   | TB-Thấp   | Cloud secure workloads, zero trust infra. |
| crun            | Thấp      | Rất cao   | IoT, edge, microservices nhỏ, cgroups v2. |
## **5. Best Practices**

1. **Không bật alternative runtimes toàn hệ thống** → chỉ áp dụng cho container nhạy cảm.
2. **Kiểm tra compatibility** vì gVisor/Kata có thể thiếu syscall.
3. **Kết hợp với Seccomp, AppArmor** để tối ưu security.
4. Test trước khi áp dụng production.
## **6. Troubleshooting**

* **Container không chạy được**:

  * Kiểm tra `docker info | grep Runtimes`.
  * Xem log `/var/log/docker.log` để biết runtime không tương thích.
* **Performance drop**:

  * Dùng `docker stats` hoặc Prometheus để so sánh runtime trước/sau.
