# 6.3. Resource constraints


#### **1. Khái niệm**

* **Resource constraints**: Giới hạn tài nguyên (CPU, RAM, Disk I/O, GPU, v.v.) mà container có thể sử dụng.
* **Mục tiêu**:

  1. **Ngăn container “ăn” hết tài nguyên** của host → tránh ảnh hưởng service khác.
  2. **Cân bằng tài nguyên** khi chạy nhiều container.
  3. **Tối ưu chi phí** trên môi trường production.
#### **2. Cơ chế hoạt động**

Docker sử dụng **Linux kernel cgroups** (control groups) để:

* Giới hạn (limit)
* Ưu tiên (prioritize)
* Giám sát (monitor) tài nguyên.
#### **3. CPU Constraints**

##### **3.1. Giới hạn CPU usage**

* **`--cpus`**: Giới hạn số CPU logic.

```bash
docker run --cpus=1.5 nginx
```

→ Container chỉ dùng tối đa **1.5 CPU core**.
##### **3.2. Giới hạn CPU shares (weight)**

* **`--cpu-shares`**: Tỉ trọng ưu tiên CPU (mặc định = 1024).

```bash
docker run --cpu-shares=512 nginx
docker run --cpu-shares=2048 redis
```

→ Redis được ưu tiên gấp đôi Nginx khi CPU full load.
##### **3.3. Giới hạn CPU affinity**

* **`--cpuset-cpus`**: Chạy container trên CPU core cụ thể.

```bash
docker run --cpuset-cpus="0,2" nginx
```

→ Chỉ chạy trên core 0 và core 2.
#### **4. Memory Constraints**

##### **4.1. Giới hạn tổng RAM**

* **`-m` / `--memory`**: Giới hạn bộ nhớ tối đa.

```bash
docker run -m 512m nginx
```

→ Container chỉ được dùng **512MB RAM**.
##### **4.2. Giới hạn Swap**

* **`--memory-swap`**: RAM + Swap tối đa.

```bash
docker run -m 512m --memory-swap=1g nginx
```

→ 512MB RAM + 512MB Swap.

* **`--memory-swap=-1`**: Không giới hạn Swap (dùng tối đa của host).
  
##### **4.3. Giới hạn Soft limit**

* **`--memory-reservation`**: Giới hạn mềm, chỉ áp khi host thiếu RAM.

```bash
docker run --memory-reservation=256m nginx
```
#### **5. I/O Constraints**

##### **5.1. Disk I/O (Block device)**

* **`--device-read-bps`**: Giới hạn tốc độ đọc.
* **`--device-write-bps`**: Giới hạn tốc độ ghi.

```bash
docker run --device-read-bps /dev/sda:1mb nginx
docker run --device-write-bps /dev/sda:500kb nginx
```
##### **5.2. Disk IOPS**

* **`--device-read-iops` / `--device-write-iops`**:

```bash
docker run --device-write-iops /dev/sda:100 nginx
```

→ Tối đa **100 write IOPS**.

#### **6. PIDs Constraint**

* **`--pids-limit`**: Giới hạn số process.

```bash
docker run --pids-limit=100 nginx
```

→ Chỉ tạo được tối đa 100 process/thread.

#### **7. GPU Constraints**

* Yêu cầu **NVIDIA Container Toolkit**.

```bash
docker run --gpus all nvidia/cuda:12.0-base nvidia-smi
docker run --gpus '"device=0,2"' ...
```

#### **8. Network Bandwidth Constraint**

* Không có flag native trong Docker CLI.
* Dùng **`tc` (traffic control)** hoặc plugin như `weave` / `calico` để giới hạn Mbps.
* Ví dụ `tc`:

```bash
tc qdisc add dev eth0 root tbf rate 10mbit burst 32kbit latency 400ms
```

#### **9. Monitor Resource Usage**

* **docker stats**: Real-time usage.

```bash
docker stats
```

* **cAdvisor** / **Prometheus**: Giám sát & cảnh báo dài hạn.

#### **10. Case Study**

##### **Case 1: Prod Web App**

* Nginx: `--cpus=1 --memory=512m`
* Redis: `--cpus=0.5 --memory=256m`
* PostgreSQL: `--cpus=2 --memory=2g --device-write-bps /dev/sda:5mb`

→ Giảm nguy cơ web bị nghẽn nếu Redis bị loop CPU.



##### **Case 2: CI/CD Server**

* Giới hạn I/O mạnh cho build container:

```bash
--device-write-bps /dev/sda:1mb --cpus=0.5 --memory=1g
```

→ Tránh build làm chết database.



#### **11. Best Practices**

1. **Luôn set giới hạn** cho container production → tránh "noisy neighbor".
2. **Giới hạn CPU bằng `--cpus` thay vì `--cpu-shares`** cho kết quả ổn định hơn.
3. **Monitor trước khi set limit**: Không nên set bừa gây bottleneck.
4. **Đừng disable Swap trừ khi bắt buộc** (tránh OOM kill đột ngột).
5. **Tách workload nặng sang node riêng** thay vì ép limit quá chặt.


