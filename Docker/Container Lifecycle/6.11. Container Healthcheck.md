# 6.11. Container Healthcheck

#### **1. Mục tiêu**

* Giám sát **trạng thái sống** của container từ bên trong.
* Tích hợp health status vào **orchestration system** (Swarm, Kubernetes, Compose).
* Tự động **restart** hoặc cô lập container khi unhealthy.
#### **2. Healthcheck là gì?**

* Là **lệnh kiểm tra định kỳ** chạy bên trong container.
* Nếu lệnh trả về **exit code 0** → Healthy, ngược lại → Unhealthy.
* Được Docker Engine ghi lại trong `docker inspect` và hiển thị ở `docker ps`.

#### **3. Cấu hình Healthcheck trong Dockerfile**

Ví dụ cơ bản:

```dockerfile
HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD curl -f http://localhost/ || exit 1
```

**Tham số:**

* `--interval` – khoảng cách giữa các lần check (mặc định 30s).
* `--timeout` – thời gian tối đa cho mỗi lần check.
* `--start-period` – thời gian khởi động trước khi check lần đầu (hữu ích cho app khởi động lâu).
* `--retries` – số lần thử trước khi đánh dấu Unhealthy.

#### **4. Healthcheck qua CLI**

Thêm khi chạy container:

```bash
docker run -d \
  --health-cmd="curl -f http://localhost || exit 1" \
  --health-interval=30s \
  --health-timeout=5s \
  --health-retries=3 \
  nginx
```
#### **5. Xem trạng thái Health**

```bash
docker ps
docker inspect <container> --format '{{json .State.Health}}' | jq
```

Output mẫu:

```json
{
  "Status": "healthy",
  "FailingStreak": 0,
  "Log": [
    {
      "Start": "2025-08-13T10:05:44.000000000Z",
      "End": "2025-08-13T10:05:44.000000000Z",
      "ExitCode": 0,
      "Output": "OK"
    }
  ]
}
```

#### **6. Kỹ thuật nâng cao**

##### **6.1. Script healthcheck phức tạp**

Thay vì 1 dòng lệnh, dùng script:

```dockerfile
COPY healthcheck.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/healthcheck.sh
HEALTHCHECK CMD ["healthcheck.sh"]
```

Ví dụ `healthcheck.sh`:

```bash
#!/bin/sh
if curl -fs http://localhost:8080/healthz | grep '"status":"ok"' > /dev/null; then
  exit 0
else
  exit 1
fi
```

* Có thể kiểm tra DB connection, disk usage, hoặc queue length.

##### **6.2. Multi-service container**

* Kiểm tra nhiều dịch vụ một lúc.
* Dùng script để check từng service và fail nếu một trong số chúng down.

##### **6.3. Sidecar healthcheck**

* Thay vì healthcheck trong container chính, chạy **container sidecar** kiểm tra và gửi alert (Prometheus Alertmanager, Slack webhook).

##### **6.4. Healthcheck + Restart Policy**

Kết hợp:

```bash
docker run --restart unless-stopped --health-cmd="curl -f http://localhost || exit 1" myapp
```

→ Container sẽ restart nếu health status chuyển sang unhealthy và policy cho phép.

#### **7. Best Practices**

* **Không check service ở public endpoint**, nên check nội bộ (localhost).
* Sử dụng `--start-period` cho app cần warm-up.
* Giữ thời gian check ngắn hơn **failover timeout** của orchestrator.
* Nếu healthcheck tốn tài nguyên → giảm tần suất hoặc dùng external monitor.
* Log đầy đủ trong script healthcheck để debug.

#### **8. Debug Healthcheck**

```bash
docker inspect --format '{{.State.Health}}' <container>
docker logs <container>
```

* Xem log output của lệnh healthcheck.
* Nếu `FailingStreak` tăng nhanh → service đang lỗi liên tục.

**Pro Tip:**
Trong **Kubernetes**, healthcheck Docker được ánh xạ thành **livenessProbe** và **readinessProbe**, giúp cluster quyết định khi nào route traffic hoặc restart pod.


