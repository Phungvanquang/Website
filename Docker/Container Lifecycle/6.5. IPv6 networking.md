# 6.5. IPv6 networking.md

#### **1. Khái niệm**

* **IPv6 Networking** cho phép container giao tiếp qua địa chỉ **IPv6** thay vì (hoặc song song với) IPv4.
* Mặc định **Docker tắt IPv6** để tránh cấu hình sai hoặc bảo mật không cần thiết.
* Hỗ trợ IPv6 trên:

  * **Bridge networks** (custom)
  * **Overlay networks** (Swarm / Docker Enterprise)
  * Host network (nếu host có IPv6)
  * Macvlan / IPvlan

#### **2. Kích hoạt IPv6 trong Docker Daemon**

##### **2.1. Chỉnh `daemon.json`**

File: `/etc/docker/daemon.json`

```json
{
  "ipv6": true,
  "fixed-cidr-v6": "2001:db8:1::/64"
}
```

* `"ipv6": true` → Bật IPv6 cho Docker daemon.
* `"fixed-cidr-v6"` → Dải IPv6 cấp cho container.

##### **2.2. Khởi động lại Docker**

```bash
sudo systemctl restart docker
```

##### **2.3. Kiểm tra**

```bash
docker info | grep IPv6
# Expected output: IPv6: true
```

#### **3. IPv6 trên Custom Bridge Network**

##### **3.1. Tạo mạng IPv6**

```bash
docker network create \
  --driver bridge \
  --ipv6 \
  --subnet "2001:db8:1::/64" \
  mynet-v6
```

##### **3.2. Run container với IPv6**

```bash
docker run -it --rm --network=mynet-v6 busybox sh
```

##### **3.3. Kiểm tra địa chỉ IPv6**

```bash
ip -6 addr
ping6 google.com
```

#### **4. IPv6 trong Overlay Network (Swarm Mode)**

##### **4.1. Init Swarm**

```bash
docker swarm init
```

##### **4.2. Tạo overlay network IPv6**

```bash
docker network create \
  --driver overlay \
  --ipv6 \
  --subnet "2001:db8:2::/64" \
  overlay-v6
```

##### **4.3. Deploy service**

```bash
docker service create --name webv6 --network overlay-v6 nginx
```

#### **5. IPv6 Host Networking**

* Nếu host đã có IPv6 public (ví dụ `2001:db8::1234`), container dùng `--network host` sẽ kế thừa stack IPv6 từ host.

```bash
docker run -it --rm --network host busybox sh
ping6 google.com
```

#### **6. IPv6 với Macvlan**

* Macvlan cho phép container nhận IPv6 trực tiếp từ router/DHCP.
* Ví dụ:

```bash
docker network create -d macvlan \
  --subnet=2001:db8:100::/64 \
  --gateway=2001:db8:100::1 \
  -o parent=eth0 macvlan-v6
```

#### **7. DNS và IPv6**

* Mặc định container dùng DNS từ `/etc/resolv.conf` của host.
* Nếu muốn ưu tiên IPv6:

```bash
docker run --dns 2001:4860:4860::8888 busybox nslookup google.com
```

#### **8. Firewall và IPv6**

* Mở port cho IPv6 (nếu dùng UFW):

```bash
sudo ufw allow proto tcp from any to any port 80
sudo ufw allow proto tcp from any to any port 443
```

* Kiểm tra rule `ip6tables -L -n`.

#### **9. Test kết nối IPv6**

* Ping IPv6 public:

```bash
ping6 2001:4860:4860::8888
```

* Truy cập web IPv6:

```bash
curl -g -6 "http://[2606:4700:4700::1111]"
```

#### **10. Best Practices**

1. Luôn **giới hạn dải IPv6** (`fixed-cidr-v6`) để tránh chiếm toàn bộ prefix.
2. Dùng firewall (`ip6tables`) để hạn chế truy cập từ IPv6 public.
3. Test kết nối IPv6 trước khi bật cho production.
4. Trong multi-host → nên dùng **Overlay IPv6** cho consistency.
5. Nếu cần tách mạng, kết hợp IPv6 với **Macvlan**.

#### **11. Case Study**

**Prod setup**:

* Custom bridge IPv4/IPv6 dual stack.
* `fixed-cidr-v6`: `2001:db8:abcd::/64`.
* `ip6tables` limit chỉ cho phép port 80/443.
* Prometheus scrape metrics IPv6 → tránh NAT.

