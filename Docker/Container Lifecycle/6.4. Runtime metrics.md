# 6.4. Runtime metrics


#### **1. Khái niệm**

* **Runtime metrics** là **thông số hiệu năng** của container khi đang chạy.
* Bao gồm:

  * CPU usage
  * Memory usage
  * Disk I/O
  * Network I/O
  * PIDs count
* **Mục tiêu**:

  1. Giám sát **sức khỏe container**.
  2. Tối ưu resource allocation.
  3. Cảnh báo sớm khi có sự cố.
#### **2. Cơ chế thu thập**

Docker dùng **cgroups** và **containerd metrics API** để lấy dữ liệu, sau đó expose qua:

1. **CLI (`docker stats`)** → Real-time snapshot.
2. **Remote API (`/containers/{id}/stats`)** → JSON stream.
3. **Monitoring agents** → cAdvisor, Prometheus, Grafana.
#### **3. Giám sát bằng Docker CLI**

##### **3.1. Lệnh `docker stats`**

```bash
docker stats
```

Hiển thị:

* CONTAINER ID / NAME
* CPU %
* MEM USAGE / LIMIT
* MEM %
* NET I/O
* BLOCK I/O
* PIDs
##### **3.2. Giám sát container cụ thể**

```bash
docker stats web01 db01
```
##### **3.3. Format & filter output**

```bash
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
```

→ Lấy 1 lần, format gọn cho script.
#### **4. API Metrics (JSON streaming)**

Docker API endpoint:

```
GET /containers/{id}/stats?stream=true
```

Ví dụ:

```bash
curl --unix-socket /var/run/docker.sock http://localhost/containers/web01/stats?stream=false
```

→ Trả JSON:

```json
{
  "cpu_stats": {...},
  "memory_stats": {...},
  "networks": {...},
  "blkio_stats": {...}
}
```

Có thể dùng trong custom monitoring system.
#### **5. Giám sát nâng cao với cAdvisor**

##### **5.1. Cài cAdvisor**

```bash
docker run \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:ro \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  --volume=/dev/disk/:/dev/disk:ro \
  --publish=8080:8080 \
  --detach \
  --name=cadvisor \
  gcr.io/cadvisor/cadvisor:latest
```
##### **5.2. Truy cập Web UI**

* Mở: [http://localhost:8080](http://localhost:8080)
* Xem **CPU, RAM, Network, Disk** theo thời gian thực cho từng container.
#### **6. Prometheus + cAdvisor + Grafana Stack**

##### **6.1. Prometheus config**

`prometheus.yml`

```yaml
scrape_configs:
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
```
##### **6.2. Run Prometheus**

```bash
docker run -d \
  -p 9090:9090 \
  -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml \
  --name prometheus \
  prom/prometheus
```
##### **6.3. Grafana dashboard**

* Run Grafana:

```bash
docker run -d -p 3000:3000 grafana/grafana
```

* Import dashboard template ID: **14282** (Docker monitoring).
#### **7. Metrics quan trọng cần theo dõi**

| Metric         | Ý nghĩa         | Ngưỡng cảnh báo         |
| -------------- | --------------- | ----------------------- |
| CPU %          | CPU usage       | > 85% lâu dài           |
| Memory usage   | RAM đang dùng   | > 90% limit             |
| Memory failcnt | Số lần OOM      | > 0                     |
| Block I/O      | Disk read/write | tăng đột biến           |
| Net I/O        | Traffic vào/ra  | tăng bất thường         |
| PIDs           | Số process      | gần bằng `--pids-limit` |
#### **8. Best Practices**

1. **Luôn dùng `--no-stream` khi script** → tránh treo process.
2. **Set limit trước rồi monitor** → tránh container ăn hết tài nguyên.
3. **Dùng cAdvisor + Prometheus** cho monitoring dài hạn.
4. **Cảnh báo dựa trên xu hướng** thay vì giá trị tức thời.
5. **Thu metrics ở cả host và container** → xác định nguyên nhân bottleneck.
#### **9. Case Study**

**Prod Web Service:**

* Prometheus scrape cAdvisor mỗi 15s.
* Alert khi:

  * CPU > 85% trong 5 phút.
  * RAM > 90% limit trong 3 phút.
  * Network I/O > 500Mbps liên tục.
* Grafana hiển thị real-time dashboard.

