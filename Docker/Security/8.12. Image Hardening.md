# 8.12. Image Hardening

`Image Hardening` là quá trình **giảm thiểu rủi ro bảo mật** bằng cách tối ưu hóa và "làm sạch" Docker Image, đảm bảo chỉ chứa những gì cần thiết, không có lỗ hổng, không phơi bày thông tin nhạy cảm. Đây là bước quan trọng trong **Docker Security Lifecycle**, giúp hạn chế bề mặt tấn công.

### 1. Nguyên tắc Image Hardening

1. **Giảm thiểu kích thước Image (Minimization)**

   * Dùng **base image nhỏ gọn**: `alpine`, `scratch`, `distroless`.
   * Loại bỏ package không cần thiết.

2. **Sử dụng Multi-Stage Build**

   * Stage 1: build (có compiler, toolchain).
   * Stage 2: copy binary sang base image sạch (runtime-only).

3. **Cập nhật định kỳ (Patch & Update)**

   * Image cần rebuild khi có bản vá từ upstream.
   * Dùng scanner (Trivy, Clair, Grype) để phát hiện CVE.

4. **Xóa thông tin nhạy cảm**

   * Không hardcode secrets (API keys, password, SSH keys).
   * Không để lại `.git/`, config test, hoặc log file trong image.

5. **Quyền hạn hạn chế (Least Privilege)**

   * Dùng `USER` thay vì chạy `root`.
   * Kết hợp Linux Capabilities và seccomp profile.

6. **Read-Only + Immutable Layers**

   * Mount volume hoặc tempfs thay vì ghi trực tiếp vào container FS.

### 2. Thực hành Image Hardening

### ✅ Ví dụ: Image không an toàn (Debian lớn, chạy root)

```dockerfile
FROM debian:latest
RUN apt-get update && apt-get install -y python3 curl git
COPY . /app
WORKDIR /app
CMD ["python3", "app.py"]
```

**Vấn đề:**

* Base image lớn (`debian`) → nhiều CVE.
* Cài thêm `curl`, `git` không cần thiết → tăng bề mặt tấn công.
* Chạy root mặc định.
* Copy toàn bộ source → có thể chứa secrets.

### ✅ Phiên bản Hardened (Multi-stage + Distroless + Non-root)

```dockerfile
# Stage 1: Build
FROM python:3.12-slim as builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --user -r requirements.txt
COPY . .

# Stage 2: Runtime
FROM gcr.io/distroless/python3-debian12
WORKDIR /app
COPY --from=builder /app /app
USER 1000
CMD ["app.py"]
```

**Cải tiến:**

* Dùng `python:slim` thay vì `debian`.
* Multi-stage → stage 2 chỉ có runtime cần thiết.
* Sử dụng **Distroless** → không shell, không package thừa.
* Chạy với `USER 1000` thay vì root.
### 3. Công cụ hỗ trợ Image Hardening

* **Scanner:**

  * Trivy, Grype, Clair → phát hiện CVE trong image.
* **Docker Bench for Security** → audit config & Dockerfile best practice.
* **Hadolint** → lint Dockerfile để phát hiện insecure pattern.
* **Aqua Security Microscanner** → kiểm tra image compliance.
### 4. Liên hệ thực tế

* Trong môi trường **CI/CD**, image nên được:

  1. Build → Scan CVE → Hardening.
  2. Push lên registry private (có ký số với Notary).
  3. Triển khai (deploy) với policy: không root, read-only FS, secrets từ vault.

