# 8.8. Linux Capabilities

### 1. Khái niệm.

* Truyền thống: root (UID=0) có toàn quyền, non-root thì rất hạn chế.
* Với **Capabilities**, root được tách thành nhiều nhóm quyền nhỏ (như `CAP_NET_ADMIN`, `CAP_SYS_ADMIN`, `CAP_CHOWN`…), container chỉ được cấp quyền cụ thể.
* Docker mặc định chạy container với một **tập hợp capabilities hạn chế** để giảm nguy cơ tấn công.
### 2. Cách Docker xử lý Capabilities.

* Khi container khởi động, Docker **drop** nhiều capabilities nguy hiểm.

* Ví dụ: mặc định Docker sẽ **loại bỏ** những quyền như:

  * `CAP_SYS_ADMIN`: gần như quyền root hoàn chỉnh (nguy hiểm).
  * `CAP_SYS_MODULE`: nạp/unload kernel module.
  * `CAP_SYS_BOOT`: reboot hệ thống.

* Đồng thời, Docker vẫn giữ lại những quyền cần thiết để container hoạt động bình thường, ví dụ:

  * `CAP_CHOWN`: thay đổi owner file.
  * `CAP_DAC_OVERRIDE`: bypass file permission.
  * `CAP_NET_BIND_SERVICE`: bind cổng nhỏ hơn 1024.
  * `CAP_SETUID` / `CAP_SETGID`: thay đổi user/group ID.

### 3. Quản lý Capabilities trong Docker.

#### Thêm Capabilities

Ví dụ: cấp quyền `NET_ADMIN` để container có thể cấu hình network interface:

```bash
docker run -it --cap-add=NET_ADMIN ubuntu bash
```

#### Xóa Capabilities

Ví dụ: chạy container nhưng loại bỏ quyền `SETUID` và `SETGID`:

```bash
docker run -it --cap-drop=SETUID --cap-drop=SETGID ubuntu bash
```

#### Xóa tất cả quyền, rồi chỉ thêm quyền cần thiết

```bash
docker run -it --cap-drop=ALL --cap-add=NET_BIND_SERVICE nginx
```

#### 4. Danh sách một số Capabilities quan trọng.

* **`CAP_SYS_ADMIN`** → quyền root gần như đầy đủ, rất nguy hiểm nếu cấp cho container.
* **`CAP_NET_ADMIN`** → thay đổi routing, firewall, network interfaces.
* **`CAP_SYS_PTRACE`** → cho phép debug/trace process, dễ bị lợi dụng.
* **`CAP_CHOWN`** → thay đổi chủ sở hữu file.
* **`CAP_NET_RAW`** → cho phép raw sockets (có thể bị dùng để sniff traffic).
* **`CAP_DAC_OVERRIDE`** → bỏ qua kiểm tra permission file.

### 5. Tác động bảo mật.

* Nếu cấp quá nhiều capabilities → container có thể **thoát ra host** hoặc chiếm quyền root.
* Nguyên tắc bảo mật: **least privilege** → chỉ cấp đúng capabilities cần thiết.
* Kết hợp với **Seccomp** và **AppArmor/SELinux** để tăng cường sandbox.

### 6. **Phân tích theo Layer trong Docker Security**

* **Daemon & Engine Layer**: Docker daemon mặc định drop nhiều quyền, tránh container ảnh hưởng kernel.
* **Container Runtime Layer**: runtime (`runc`, `containerd`) enforce capabilities thông qua Linux kernel.
* **Application Layer**: DevOps/security engineer phải xác định ứng dụng cần quyền nào → chỉ cấp đúng quyền.


Bạn có muốn mình viết thêm **danh sách đầy đủ các Capabilities mà Docker giữ lại mặc định và những cái bị loại bỏ** (theo Docker 20.x trở lên) không?
