# 8.6. Content Trust & Notary

### 1. Khái niệm.

* **Content Trust** trong Docker là cơ chế đảm bảo rằng image bạn pull/push được **xác minh tính toàn vẹn và tính xác thực** thông qua chữ ký số (digital signatures).
* Docker triển khai điều này qua **Notary**, một dịch vụ sử dụng **TUF (The Update Framework)** để quản lý khóa, metadata, và chữ ký cho image.

Nói cách khác:

* Không có Content Trust → bạn pull một image có thể bị attacker thay đổi trên registry.
* Có Content Trust → chỉ image đã được **signed** (ký số) mới được xác thực và sử dụng.
### 2. Hoạt động (Workflow).

1. **Kích hoạt Docker Content Trust (DCT)**

   * Docker tắt Content Trust mặc định.
   * Để bật:

     ```bash
     export DOCKER_CONTENT_TRUST=1
     ```
   * Giờ đây mọi lệnh `docker pull`, `docker push`, `docker build` sẽ kiểm tra chữ ký số.

2. **Quy trình ký số (Signing)**

   * Khi bạn push một image lần đầu:

     * Docker client sẽ tạo **root key** và **repository key** (nếu chưa có).
     * Notary server sẽ lưu metadata và chữ ký gắn với image.
     * Các key:

       * **Root key**: lưu trên máy dev, cực kỳ nhạy cảm.
       * **Repository key**: dùng để ký cho repo cụ thể.
       * **Targets key**: ký cho tag cụ thể (`v1`, `latest`, v.v.).

   Ví dụ:

   ```bash
   docker push myregistry.com/myapp:1.0
   ```

   → Image `myapp:1.0` sẽ được ký.

3. **Quy trình xác thực (Verification)**

   * Khi bạn `docker pull myapp:1.0`, client sẽ:

     * Lấy metadata từ Notary server.
     * Kiểm tra chữ ký của image tag.
     * Nếu hợp lệ → cho phép tải về.
     * Nếu không có chữ ký hoặc bị giả mạo → từ chối.
### 3. Các thành phần quan trọng.

1. **Docker Content Trust (DCT)**

   * Cấu hình qua biến môi trường.
   * `DOCKER_CONTENT_TRUST=1` → bắt buộc image phải có chữ ký.
   * `DOCKER_CONTENT_TRUST=0` → tắt kiểm tra chữ ký (không khuyến khích).

2. **Notary Server**

   * Triển khai riêng hoặc dùng Docker Hub (có tích hợp sẵn).
   * Lưu metadata (chữ ký, keys, timestamp).

3. **The Update Framework (TUF)**

   * Giao thức bảo mật underpinning của Notary.
   * Giải quyết các vấn đề như **key compromise, rollback attack, freeze attack**.
### 4. Tác động bảo mật.

✅ **Bảo vệ tính toàn vẹn (Integrity)** – đảm bảo image không bị sửa đổi sau khi build.
✅ **Xác thực nguồn gốc (Authenticity)** – chỉ image từ nhà phát triển hợp pháp được chạy.
✅ **Chống tấn công Man-in-the-Middle** – ngăn attacker chèn image độc hại khi pull.
✅ **Chống rollback attack** – ngăn attacker ép client dùng version cũ có lỗ hổng.
### 5. Phân tích theo Layer.

* **Application Layer**: DevOps chỉ chạy image đã được ký → giảm rủi ro supply chain attack.
* **Transport Layer**: Notary server giao tiếp qua HTTPS để tránh MITM.
* **Registry Layer**: Docker Hub hoặc private registry lưu metadata chữ ký.
* **Client Layer**: Docker CLI kiểm tra chữ ký trước khi tải/khởi chạy container.
### 6. Ví dụ thực tế.

**Bật Content Trust và ký số image:**

```bash
export DOCKER_CONTENT_TRUST=1
docker push myregistry.com/myapp:2.0
```

**Xem metadata chữ ký bằng Notary:**

```bash
notary list myregistry.com/myapp
```

**Khi pull image không có chữ ký:**

```bash
docker pull myregistry.com/evilapp:latest
# Error: no trust data for evilapp:latest
```


