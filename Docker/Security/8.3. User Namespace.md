# 8.3. User Namespace.md

#### **8.3. User Namespace**
##### **1. Khái niệm**
**User Namespace** là một tính năng bảo mật của Linux cho phép ánh xạ **UID/GID bên trong container** sang **UID/GID khác trên host**.
Điều này giúp tiến trình trong container **tưởng rằng** chúng chạy với quyền root (`UID 0`) nhưng thực tế trên host chúng chỉ là một user không có quyền root.

Docker sử dụng User Namespace để **cô lập quyền hạn**, giảm nguy cơ container có thể can thiệp vào hệ thống host khi bị tấn công.
##### **2. Lợi ích**

*  Ngăn container root có toàn quyền trên host.
*  Giảm thiểu rủi ro **privilege escalation**.
*  Bổ sung thêm lớp bảo mật bên cạnh **seccomp**, **AppArmor** hoặc **SELinux**.
*  Cho phép mapping nhiều user khác nhau cho các container khác nhau.
##### **3. Hạn chế**

* Một số tính năng không hoạt động tốt hoặc cần cấu hình đặc biệt:

  * **Volume bind mount** có thể gặp vấn đề quyền truy cập.
  * Một số network driver hoặc kernel module yêu cầu quyền root thật.
  * Image yêu cầu UID cố định có thể cần chỉnh lại file ownership.
* Phức tạp hơn khi cần debug quyền truy cập file.
##### **4. Cách hoạt động**

Ví dụ:

* UID `0` trong container → ánh xạ thành UID `100000` trên host.
* UID `1` trong container → ánh xạ thành UID `100001` trên host.

Điều này được quản lý thông qua file:

```
/etc/subuid
/etc/subgid
```

Ví dụ:

```
dockeruser:100000:65536
```

→ User `dockeruser` được cấp 65536 UID bắt đầu từ 100000.
##### **5. Kích hoạt User Namespace trong Docker**
###### Bước 1 – Chỉnh `daemon.json`
```json
{
  "userns-remap": "default"
}
```
###### Bước 2 – Restart Docker
```bash
sudo systemctl restart docker
```
###### Bước 3 – Kiểm tra
```bash
docker info | grep userns
# Output: userns mode: private
```
##### **6. Mapping tùy chỉnh**
###### Tạo user riêng
```bash
sudo useradd dockremap
```
###### Cấu hình `/etc/subuid` và `/etc/subgid`
```text
dockremap:100000:65536
dockremap:165536:65536
```
###### Sửa `daemon.json`

```json
{
  "userns-remap": "dockremap"
}
```

Restart Docker để áp dụng.

##### **7. Ví dụ thực tế**

###### Kiểm tra UID trong container

```bash
docker run --rm -it alpine sh
# id
# uid=0(root) gid=0(root)
```

###### Kiểm tra UID trên host

```bash
ps aux | grep containerd-shim
# UID=100000 (thay vì 0)
```
##### **8. Best Practices**

* Luôn bật User Namespace trên môi trường multi-tenant.
* Dùng mapping riêng cho từng nhóm container để cô lập tối đa.
* Kết hợp với `--cap-drop ALL` để loại bỏ quyền không cần thiết.
* Cẩn thận khi bind mount — có thể cần `chown` dữ liệu theo UID được ánh xạ.
* Test kỹ ứng dụng yêu cầu UID/GID cố định.
##### **9. Tài liệu tham khảo**

* [Docker User Namespace Docs](https://docs.docker.com/engine/security/userns-remap/)
* [Kernel.org User Namespace](https://www.kernel.org/doc/html/latest/userspace-api/user_namespaces.html)
* [Subuid/Subgid manual](https://man7.org/linux/man-pages/man5/subuid.5.html)


