# 8.2. AppArmor


#### **8.2. AppArmor**
##### **1. Khái niệm**

**AppArmor** (Application Armor) là cơ chế **Mandatory Access Control (MAC)** trên Linux, cho phép áp dụng các **profile bảo mật** để kiểm soát hành vi của tiến trình, bao gồm container.
Docker khi chạy trên hệ thống hỗ trợ AppArmor sẽ **tự động gán** profile `docker-default` cho container nhằm giảm rủi ro bảo mật.

AppArmor sử dụng **path-based access control** (kiểm soát theo đường dẫn file) thay vì label như SELinux.
##### **2. Lợi ích**

* Giới hạn quyền truy cập file, network, capability của container.
* Ngăn chặn container truy cập trái phép vào tài nguyên host.
* Có thể tạo prfile tùy chỉnh cho từng workload/container.
* Kết hợp tốt với **seccomp** và **capabilities** để tạo nhiều lớp bảo vệ.
##### **3. Hạn chế**

* Chỉ hoạt động trên hệ thống có kernel hỗ trợ AppArmor (Ubuntu, Debian…).
* Không hỗ trợ tốt trên CentOS/RHEL (vì dùng SELinux).
* Cần quản lý profile cẩn thận, sai cấu hình có thể gây lỗi ứng dụng.
* Không tương thích với một số driver hoặc runtime đặc biệt.
##### **4. Kiểm tra & Kích hoạt AppArmor**

* **Kiểm tra trạng thái**:

```bash
sudo aa-status
```

Output ví dụ:

```
apparmor module is loaded.
45 profiles are loaded.
40 profiles are in enforce mode.
```

* **Kiểm tra profile của container**:

```bash
docker run --rm alpine cat /proc/1/attr/current
# Output: docker-default (enforce)
```
##### **5. Sử dụng với Docker**

* **Dùng profile mặc định** (tự động áp dụng nếu host hỗ trợ).
* **Tắt AppArmor cho container** (không khuyến nghị):

```bash
docker run --security-opt apparmor=unconfined alpine
```

* **Gán profile tùy chỉnh**:

```bash
docker run --security-opt apparmor=my-profile alpine
```
##### **6. Tạo profile tùy chỉnh**

###### Bước 1 – Tạo file `/etc/apparmor.d/docker-myapp`

```text
#include <tunables/global>

profile docker-myapp flags=(attach_disconnected,mediate_deleted) {
    # Kế thừa các quyền cơ bản
    #include <abstractions/base>
    network,
    capability,
    file,

    # Cho phép đọc/ghi /data
    /data/** rw,

    # Chặn ghi /etc
    deny /etc/** w,

    # Cho phép chạy shell
    /bin/sh ix,

    # Mặc định deny các hành động khác
    deny /** wklx,
}
```
###### Bước 2 – Load profile

```bash
sudo apparmor_parser -r /etc/apparmor.d/docker-myapp
```
###### Bước 3 – Áp dụng khi chạy container

```bash
docker run --security-opt apparmor=docker-myapp alpine
```
##### **7. Debug & Troubleshooting**

* **Xem log vi phạm**:

```bash
sudo dmesg | grep DENIED
# hoặc
journalctl -k | grep DENIED
```

* **Chạy profile ở chế độ complain** (log nhưng không chặn):

```bash
sudo aa-complain docker-myapp
```

* **Chuyển lại enforce**:

```bash
sudo aa-enforce docker-myapp
```
##### **8. Best Practices**

* Luôn test profile với chế độ complain trước khi enforce.
* Áp dụng nguyên tắc **least privilege** – chỉ cấp quyền tối thiểu.
* Kết hợp với **seccomp** và **cap-drop**:

```bash
docker run \
  --security-opt apparmor=docker-myapp \
  --security-opt seccomp=seccomp-profile.json \
  --cap-drop ALL alpine
```



### **9. Tài liệu tham khảo**

* [Docker + AppArmor Docs](https://docs.docker.com/engine/security/apparmor/)
* [AppArmor Manual](https://gitlab.com/apparmor/apparmor/-/wikis/Documentation)
* [Ubuntu AppArmor Guide](https://ubuntu.com/server/docs/security-apparmor)


