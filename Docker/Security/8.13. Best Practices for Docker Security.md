# 8.13. Best Practices for Docker Security

## 1. Nguyên tắc chung

* **Least Privilege**: chỉ cấp quyền tối thiểu cần thiết cho container, user, volume, capability.
* **Defense in Depth**: kết hợp nhiều lớp bảo vệ (AppArmor, Seccomp, Capabilities, Read-only FS, Scanner).
* **Immutable Infrastructure**: container nên “immutable” (không thay đổi sau khi build).
## 2. Best Practices trong quá trình Build Image

1. **Chọn base image an toàn**

   * Sử dụng official image từ Docker Hub hoặc trusted registry.
   * Ưu tiên **distroless images** hoặc **alpine** để giảm attack surface.

2. **Giảm kích thước image**

   * Multi-stage build để chỉ giữ các binary cần thiết.
   * Xoá package manager (apt, yum) sau khi cài để giảm vector tấn công.

3. **Không hardcode secrets**

   * Không lưu API key, password trong `Dockerfile`, ENV, hoặc code.
   * Dùng **Docker secrets**, Vault, hay K8s secrets.

4. **Chạy với non-root user**

   ```dockerfile
   FROM alpine:3.20
   RUN adduser -D appuser
   USER appuser
   ```

   → Tránh chạy container với UID 0 (root).
## 3. Best Practices khi chạy Container

1. **Hạn chế quyền**

   * Dùng `--cap-drop ALL` và chỉ `--cap-add` những gì cần.
   * Sử dụng `--read-only` filesystem.
   * Dùng **seccomp profile** và **AppArmor/SELinux**.

2. **Giới hạn tài nguyên**

   * CPU, RAM, IO:

     ```bash
     docker run --memory=512m --cpus="1.0" ...
     ```
   * Tránh DoS từ container độc hại.

3. **Không mount volume nhạy cảm**

   * Tránh mount `/var/run/docker.sock` vào container (nguy cơ full host compromise).
   * Kiểm soát volume với `:ro` (read-only).

4. **Network security**

   * Dùng `docker network create` để cô lập container.
   * Không để container lộ port không cần thiết (`-p` chỉ khi cần).
   * Sử dụng **firewall rules** để giới hạn traffic.
## 4. Monitoring & Scanning

1. **Quét lỗ hổng image**

   * **Trivy**, **Clair**, **Anchore**, **Aqua Security**.

2. **Runtime security**

   * **Falco**: giám sát syscalls container.
   * **AppArmor/SELinux logs**: phát hiện hành vi bất thường.

3. **Logging & Audit**

   * Kết hợp Docker logs với ELK/Prometheus/Grafana.
   * Audit container exec (`docker exec`) để tránh misuse.
## 5. Compliance & Policy

* Tích hợp **CIS Docker Benchmark** kiểm tra config.
* Sử dụng **OPA/Gatekeeper** để enforce policy.
* Quản lý image bằng **private registry** với signed images (Docker Content Trust, Notary v2).
## 6. Checklist nhanh

- Chạy container với **non-root user**
- Drop **Linux Capabilities** không cần thiết
- Sử dụng **read-only filesystem**
- Áp dụng **Seccomp + AppArmor/SELinux**
- Không để secrets trong image
- Quét image trước khi deploy
- Giới hạn tài nguyên container
- Không mount socket Docker trực tiếp
- Sử dụng private registry & signed images
- Monitoring & logging liên tục

