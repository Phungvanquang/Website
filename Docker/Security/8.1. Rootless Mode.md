# 8.1. Rootless Mode

#### **8.1. Rootless Mode**
##### **1. Khái niệm**

Rootless Mode là chế độ chạy Docker **mà không cần quyền root** (cả cho daemon và container).
Điều này giảm rủi ro bảo mật nếu Docker hoặc container bị tấn công, vì tiến trình Docker không thể truy cập trực tiếp vào hệ thống.

Docker Rootless hoạt động dựa trên **user namespaces** trong Linux, giúp ánh xạ UID/GID trong container sang UID/GID của người dùng thường.
##### **2. Lợi ích**

*  Giảm nguy cơ leo thang đặc quyền (**privilege escalation**).
*  Không yêu cầu quyền root để chạy container.
*  Hạn chế tác động của container bị compromise tới hệ thống host.
*  Có thể chạy song song với Docker rootful trên cùng hệ thống.

##### **3. Hạn chế**

* Một số tính năng **không hỗ trợ** hoặc bị giới hạn:

  * **Binding cổng < 1024** (do không có quyền CAP\_NET\_BIND\_SERVICE).
  * Storage driver bị giới hạn (thường dùng `fuse-overlayfs` thay vì `overlay2`).
  * Không hỗ trợ `macvlan` hoặc một số network driver yêu cầu root.
  * Hiệu năng I/O có thể thấp hơn do cơ chế user namespace.
##### **4. Cài đặt Rootless Mode**
###### **Bước 1** – Cài Docker CLI (nếu chưa có)

```bash
curl -fsSL https://get.docker.com/rootless | sh
```
###### **Bước 2** – Thiết lập biến môi trường

Thêm vào `~/.bashrc` hoặc `~/.zshrc`:

```bash
export PATH=$HOME/bin:$PATH
export DOCKER_HOST=unix:///run/user/$(id -u)/docker.sock
```

Rồi load lại:

```bash
source ~/.bashrc
```
###### **Bước 3** – Khởi động Rootless Docker daemon

```bash
systemctl --user start docker
```

Hoặc chạy trực tiếp:

```bash
dockerd-rootless.sh
```
##### **5. Sử dụng**

Chạy container bình thường nhưng **không cần sudo**:

```bash
docker run --rm -it alpine sh
```

Kiểm tra daemon đang chạy ở chế độ rootless:

```bash
docker info | grep Rootless
# Output: Rootless: true
```
##### **6. Cấu hình nâng cao**

* **Custom data root**

```bash
DOCKERD_ROOTLESS_ROOT=/path/to/docker-data dockerd-rootless.sh
```

* **Enable IPv6**

  * Sửa file cấu hình `~/.config/docker/daemon.json`:

```json
{
  "ipv6": true,
  "fixed-cidr-v6": "fd00:dead:beef::/48"
}
```

* Restart daemon:

```bash
systemctl --user restart docker
```
##### **7. Khi nào nên dùng Rootless Mode**

* Máy cá nhân / dev environment muốn chạy Docker không cần root.
* CI/CD runners cần tách biệt tối đa với hệ thống host.
* Multi-tenant environment (nhiều user dùng chung máy).
##### **8. So sánh Rootless vs Rootful**

| Tiêu chí         | Rootful (mặc định) | Rootless          |
| ---------------- | ------------------ | ----------------- |
| Quyền truy cập   | root               | user thường       |
| Bảo mật          | Trung bình         | Cao hơn           |
| Hỗ trợ tính năng | Đầy đủ             | Một số hạn chế    |
| Hiệu năng        | Tối ưu             | Có thể giảm nhẹ   |
| Dễ cài đặt       | Dễ                 | Cần cấu hình thêm |
##### **9. Tài liệu tham khảo**

* [Docker Rootless Mode Docs](https://docs.docker.com/engine/security/rootless/)
* [RootlessKit GitHub](https://github.com/rootless-containers/rootlesskit)
