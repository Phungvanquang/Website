# 8.10. Secrets Management


### 1. Khái niệm.

Secrets Management là cơ chế bảo mật giúp quản lý, lưu trữ và phân phối **thông tin nhạy cảm** (secrets) như:

* Mật khẩu (passwords)
* API keys
* Tokens
* Certificates
* SSH keys

Trong Docker, thay vì lưu trữ secrets trực tiếp trong **Dockerfile** hoặc **environment variables** (cách này rất nguy hiểm vì dễ bị lộ khi inspect image hoặc log), Docker cung cấp cơ chế an toàn hơn thông qua **Docker Secrets** (trong Docker Swarm) hoặc tích hợp với **các hệ thống quản lý secrets chuyên dụng** (HashiCorp Vault, AWS Secrets Manager, Azure Key Vault, v.v.).

### 2. Hoạt động.

Secrets Management trong Docker chủ yếu có 2 phương pháp:

1. **Docker Secrets (native, trong Swarm mode)**

   * Secrets được lưu trong **Raft log** của Docker Swarm, được **mã hóa**.
   * Khi container cần secrets, Docker **mount secrets dưới dạng file tạm thời** trong `/run/secrets/`.
   * Chỉ container trong **service được cấp quyền** mới thấy secrets.
   * Secrets không bị expose trong image hoặc env vars.

2. **Tích hợp với Secret Store ngoài** (Vault, AWS, GCP, Azure)

   * Container có thể lấy secrets thông qua **API call** hoặc agent sidecar.
   * Quản lý vòng đời (lifecycle) của secrets, có thể **tự động rotate**.
   * Cho phép kiểm soát chặt chẽ hơn bằng **Access Control (RBAC)**.

### 3. **Tác động bảo mật**

* 🔒 **Ngăn lộ secrets trong image** → kẻ tấn công không thể lấy mật khẩu/API key từ image.
* 🔒 **Giảm nguy cơ log/inspect leak** → secrets không xuất hiện trong log hoặc docker inspect.
* 🔒 **Quản lý quyền truy cập chi tiết** → chỉ container/service được phép mới có secrets.
* 🔒 **Dễ dàng rotate** → thay đổi secrets mà không cần rebuild image.

Nếu không dùng secrets management đúng cách (ví dụ hard-code mật khẩu trong Dockerfile), attacker có thể **reverse image** và lấy được thông tin nhạy cảm.
### 4. Phân tích trong Layer Security (Docker Security Model).

* **Host Security**: Secrets được lưu trong **Swarm manager nodes** và được mã hóa → host bị tấn công khó lấy plaintext secrets.
* **Container Security**: Secrets chỉ được mount vào container trong runtime → nếu container không có quyền, nó không thấy secrets.
* **Image Security**: Secrets không nằm trong Dockerfile → không bị bake cứng vào image.
* **Orchestration Security**: Quản lý phân phối secrets qua Swarm/Kubernetes hoặc các secret stores → kiểm soát truy cập tập trung.

### 5. Ví dụ minh họa.

**Tạo secret trong Docker Swarm**:

```bash
# Khởi tạo Swarm (nếu chưa có)
docker swarm init

# Tạo secret
echo "my_super_secret_password" | docker secret create db_pass -

# Liệt kê secret
docker secret ls
```

**Sử dụng secret trong service**:

```bash
docker service create \
  --name mydb \
  --secret db_pass \
  mysql:latest
```

Trong container MySQL, secret sẽ được mount tại:

```bash
/run/secrets/db_pass
```

→ Ứng dụng chỉ cần đọc file này để lấy mật khẩu.


