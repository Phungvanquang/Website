# 8.4. Protect Daemon Socket.md

##### **1. Khái niệm**

Docker daemon (`dockerd`) lắng nghe trên **Unix socket** (`/var/run/docker.sock`) hoặc **TCP socket**.
Socket này là **API control endpoint** cho phép thực hiện **mọi lệnh quản trị** (build, run, stop container, truy cập filesystem host, v.v.).

**Nguy hiểm:** Bất kỳ ai có quyền đọc/ghi vào socket này **có toàn quyền root trên host**, vì Docker có thể mount `/` và chạy shell bên trong.
##### **2. Rủi ro bảo mật**

* Người dùng không đáng tin có thể:

  * Mount filesystem host và chỉnh sửa file hệ thống.
  * Chạy container với `--privileged` và chiếm quyền root host.
  * Truy xuất hoặc xóa dữ liệu nhạy cảm.
* Các dịch vụ CI/CD (Jenkins, GitLab Runner, ...) khi gắn socket vào container build có thể bị khai thác.
##### **3. Cách bảo vệ**

###### **3.1. Giới hạn quyền truy cập Unix Socket**

```bash
ls -l /var/run/docker.sock
# srw-rw---- 1 root docker 0 Aug 12 09:00 /var/run/docker.sock
```

Chỉ user trong group `docker` mới có quyền.
**Best practice:** Không thêm user vào group `docker` nếu không thật sự cần.
###### **3.2. Sử dụng TLS cho TCP Socket**

**Cấu hình `/etc/docker/daemon.json`**:

```json
{
  "hosts": ["tcp://0.0.0.0:2376"],
  "tls": true,
  "tlscert": "/etc/docker/certs/server-cert.pem",
  "tlskey": "/etc/docker/certs/server-key.pem",
  "tlscacert": "/etc/docker/certs/ca.pem",
  "tlsverify": true
}
```

**Khởi động lại Docker**:

```bash
sudo systemctl restart docker
```

**Kết nối bảo mật từ client**:

```bash
docker --tlsverify \
  --tlscacert=ca.pem \
  --tlscert=cert.pem \
  --tlskey=key.pem \
  -H=tcp://host.example.com:2376 info
```
###### **3.3. Sử dụng Docker API Proxy**

Dùng **socat** hoặc **nginx** để làm proxy API và chặn các lệnh nguy hiểm.

Ví dụ với `socat`:

```bash
socat TCP-LISTEN:2375,reuseaddr,fork UNIX-CONNECT:/var/run/docker.sock
```

Chỉ mở một số IP tin cậy qua firewall.
###### **3.4. Chạy Docker Rootless**

Kết hợp với **Rootless Mode** (phần 8.1) để giảm rủi ro khi socket bị lộ.

###### **3.5. Tách socket cho từng dịch vụ**

Docker 20.10+ hỗ trợ **API Access Authorization Plugins**, cho phép giới hạn hành động dựa trên user/service.
##### **4. Kiểm tra ai đang dùng Docker Socket**

```bash
lsof /var/run/docker.sock
```

Hoặc:

```bash
ss -ltnp | grep dockerd
```
##### **5. Mô hình gắn socket an toàn trong CI/CD**

**Không an toàn**:

```yaml
volumes:
  - /var/run/docker.sock:/var/run/docker.sock
```

✅ **An toàn hơn**:

* Dùng **Docker-in-Docker (dind)** tách biệt daemon.
* Hoặc **kaniko**, **buildah** để build image mà không cần socket.
##### **6. Best Practices**

* Không mount `/var/run/docker.sock` vào container trừ khi bắt buộc.
* Dùng **TLS + firewall** khi mở socket qua TCP.
* Giới hạn user được thêm vào group `docker`.
* Kết hợp với **User Namespace** và **seccomp**.
* Audit định kỳ socket activity.
##### **7. Tài liệu tham khảo**

* [Docker API Access Control](https://docs.docker.com/engine/security/https/)
* [Authorization Plugins](https://docs.docker.com/engine/extend/plugins_authorization/)
* [Docker socket security warning](https://www.portainer.io/blog/docker-socket-security)

